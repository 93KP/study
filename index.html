<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Premium Ebook Reader — Secure Access</title>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.142/pdf.min.js"></script>

<style>
  :root{
    --accent1:#0ea5a4;
    --accent2:#0369a1;
    --muted:#6b7280;
    --card:#ffffff;
    --glass: rgba(255,255,255,0.85);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(135deg,#071b2f 0%, #063b4a 55%, #083344 100%);
    color:#072a2a;
    min-height:100vh;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  /* Header / hero */
  header{
    width:100%;
    max-width:1200px;
    padding:28px 20px;
    display:flex;
    gap:20px;
    align-items:center;
    justify-content:space-between;
  }
  .brand{
    display:flex;
    gap:16px;
    align-items:center;
    color:white;
  }
  .logo{
    width:56px;
    height:56px;
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-weight:700;
    box-shadow:0 8px 30px rgba(3,105,161,0.18);
    transform:translateZ(0);
  }
  .brand h1{margin:0;font-size:20px}
  .brand p{margin:0;font-size:12px;color:#cfeff0;opacity:0.9}

  nav{display:flex;gap:10px;align-items:center}
  .ghost{
    color:#dbeafe;
    border:1px solid rgba(255,255,255,0.08);
    padding:8px 12px;border-radius:10px;
    font-size:14px;
    backdrop-filter: blur(6px);
  }

  /* main grid */
  main{
    width:100%;
    max-width:1200px;
    padding:20px;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:28px;
    align-items:start;
  }

  /* left card */
  .card{
    background:var(--glass);
    border-radius:18px;
    padding:22px;
    box-shadow: 0 12px 40px rgba(2,6,23,0.5);
    color:#042f2f;
    border:1px solid rgba(255,255,255,0.06);
  }
  .book-cover{
    width:100%;
    border-radius:12px;
    height:260px;
    overflow:hidden;
    background:linear-gradient(180deg,var(--accent2), #062a3a);
    display:flex;
    align-items:center;
    justify-content:center;
    color:white;
    font-size:28px;
    font-weight:700;
    margin-bottom:16px;
    box-shadow: inset 0 -40px 80px rgba(0,0,0,0.18);
  }
  .meta{display:flex;flex-direction:column;gap:6px;margin-bottom:14px}
  .meta .title{font-size:20px;font-weight:700}
  .meta .author{font-size:13px;color:var(--muted)}
  .desc{font-size:14px;color:#163a3b;margin-bottom:18px;line-height:1.4}

  .input-row{display:flex;gap:10px}
  .input-row input{
    flex:1;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);
    font-size:16px;
  }
  .btn{
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    color:white;border:none;padding:12px 16px;border-radius:10px;font-weight:700;
    cursor:pointer;box-shadow:0 10px 30px rgba(3,105,161,0.18);transition:transform .14s;
  }
  .btn:active{transform:translateY(1px)}
  .hint{font-size:13px;color:#145e5b;margin-top:10px}

  /* right: viewer panel */
  .viewer-panel{
    min-height:520px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:18px;padding:12px;border:1px solid rgba(255,255,255,0.03);
    display:flex;flex-direction:column;gap:12px;
  }

  .controls{
    display:flex;align-items:center;gap:12px;padding:8px;
  }
  .status{flex:1;color:#bfeaea;font-size:14px}
  .small-btn{padding:8px 12px;border-radius:10px;background:#043a3d;color:white;border:none;cursor:pointer}

  /* reader overlay */
  .reader{
    display:none;
    position:fixed;inset:0;background:rgba(6,10,11,0.9);z-index:1000;
    align-items:center;justify-content:center;flex-direction:column;padding:18px;
  }
  .reader .close{
    position:absolute;top:18px;right:18px;background:rgba(255,255,255,0.06);border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;
  }
  .reader .canvas-wrap{width:100%;max-width:1200px;height:86vh;overflow:auto;border-radius:12px;background:#0b1520;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
  .watermark{
    position:fixed;left:10px;bottom:10px;color:rgba(255,255,255,0.06);font-size:12px;pointer-events:none;
  }

  footer{width:100%;max-width:1200px;text-align:center;color:#cfeff0;opacity:0.9;padding:22px 0;font-size:13px}

  @media(max-width:980px){
    main{grid-template-columns:1fr; padding:20px}
    .book-cover{height:200px}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">K</div>
    <div>
      <h1 style="color:white;margin:0">Kushagra — Secure Reader</h1>
      <p style="margin:0">Protected ebook portal • deliver confidently</p>
    </div>
  </div>
  <nav>
    <div class="ghost">v1.0</div>
  </nav>
</header>

<main>
  <!-- LEFT: Purchase / Password card -->
  <section class="card">
    <div class="book-cover">HIDDEN TRUTH</div>

    <div class="meta">
      <div class="title">Beyond Independence: British Contributions to India's Rise</div>
      <div class="author">by Kushagra Pal</div>
    </div>

    <div class="desc">Welcome — enter your access password below. After verification the reader will open in a secure viewer. You can revoke any password anytime from Supabase dashboard.</div>

    <div style="display:flex;flex-direction:column;gap:10px">
      <div class="input-row">
        <input id="pw" type="password" placeholder="Enter password (one-time or provided)">
        <button class="btn" id="unlockBtn">Unlock</button>
      </div>
      <div class="hint">Tip: Keep a copy of assigned password. You can disable them anytime.</div>
    </div>
  </section>

  <!-- RIGHT: live status + info -->
  <aside class="viewer-panel card" style="padding:18px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700;color:#cfeff0">Reader Status</div>
      <button id="testBtn" class="small-btn">Test Connection</button>
    </div>

    <div class="controls">
      <div class="status" id="status">Not connected</div>
      <button id="openPublic" class="small-btn">Open Public PDF</button>
    </div>

    <div style="padding:8px;color:#bfeaea;font-size:14px">
      <strong>Notes:</strong>
      <ul style="margin:8px 0 0 18px;color:#bfeaea">
        <li>Passwords are checked on Supabase `users` table (password / status / pdf_file).</li>
        <li>PDF served from your public bucket: <code>storage/v1/object/public/ebooks/ht.pdf</code></li>
        <li>Watermark appears in viewer (non-intrusive) to discourage sharing.</li>
      </ul>
    </div>
  </aside>
</main>

<!-- Reader overlay -->
<div class="reader" id="reader">
  <button class="close" id="closeReader">Close</button>
  <div class="canvas-wrap" id="canvasWrap" aria-live="polite"></div>
  <div class="watermark" id="watermark">Loading…</div>
</div>

<footer>© 2026 Kushagra • Built with Supabase & PDF.js</footer>

<script>
/* ============================
   CONFIG - set your keys
   ============================ */
const SUPABASE_URL = "https://myaaijkmljjtdfoouwgt.supabase.co";
const SUPABASE_ANON = "sb_publishable_vdD93tHbk2vuDtGPsFEHMw_2iBQgXu3";
const BUCKET = "ebooks"; // your public bucket name
const DEFAULT_PUBLIC_PATH = SUPABASE_URL + "/storage/v1/object/public/" + BUCKET + "/";

/* initialize supabase client */
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* UI elements */
const unlockBtn = document.getElementById("unlockBtn");
const pwInput = document.getElementById("pw");
const statusEl = document.getElementById("status");
const testBtn = document.getElementById("testBtn");
const openPublic = document.getElementById("openPublic");
const reader = document.getElementById("reader");
const canvasWrap = document.getElementById("canvasWrap");
const watermark = document.getElementById("watermark");
const closeReader = document.getElementById("closeReader");

/* PDF.js worker configure (automatically used from library) */
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.142/pdf.worker.min.js';

/* Helpers */
function showStatus(txt, ok=true){
  statusEl.innerText = txt;
  statusEl.style.color = ok ? "#a7f3d0" : "#ffd2d2";
}

/* Test connection */
testBtn.addEventListener("click", async ()=> {
  showStatus("Checking Supabase connectivity...", true);
  try{
    // simple ping: list buckets or do a harmless select
    const { data, error } = await supabase.from("users").select("*").limit(1);
    if(error) {
      showStatus("Supabase error: " + error.message, false);
    } else {
      showStatus("Supabase reachable ✓", true);
    }
  }catch(e){
    showStatus("Connection failed: " + e.message, false);
  }
});

/* If you want to open the public PDF directly (for testing) */
openPublic.addEventListener("click", ()=>{
  const publicUrl = DEFAULT_PUBLIC_PATH + "ht.pdf";
  // open in new tab
  window.open(publicUrl, "_blank");
});

/* Render PDF from ArrayBuffer (hides browser toolbar) */
async function renderPdfFromArrayBuffer(arrayBuffer, watermarkText){
  canvasWrap.innerHTML = ""; // clear
  watermark.innerText = watermarkText || "";
  // loading
  try{
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const scale = Math.max(1.25, (window.innerWidth >= 1200 ? 1.6 : 1.0));
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement("canvas");
      canvas.style.display = "block";
      canvas.style.margin = "14px auto";
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      canvasWrap.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;
    }
    reader.style.display = "flex";
  }catch(e){
    alert("Failed to render PDF: " + (e.message||e));
    console.error(e);
  }
}

/* Main unlock logic: check Supabase users table and fetch public file */
unlockBtn.addEventListener("click", async ()=>{
  const pass = pwInput.value.trim();
  if(!pass){ alert("Enter password"); pwInput.focus(); return; }

  showStatus("Verifying password...", true);

  try{
    const res = await supabase
      .from("users")
      .select("pdf_file")
      .eq("password", pass)
      .eq("status", "active")
      .single();

    if(res.error){
      showStatus("DB error: " + res.error.message, false);
      return;
    }
    if(!res.data || !res.data.pdf_file){
      showStatus("Invalid password or no file assigned", false);
      return;
    }

    // build public URL (public bucket)
    const fileName = encodeURIComponent(res.data.pdf_file);
    const publicUrl = DEFAULT_PUBLIC_PATH + fileName + "?v=" + Date.now(); // cache-bypass
    showStatus("Fetching ebook...", true);

    // fetch as arrayBuffer to render with pdf.js (prevents browser toolbar)
    const r = await fetch(publicUrl);
    if(!r.ok){
      showStatus("Failed to fetch PDF ("+r.status+")", false);
      return;
    }
    const arrayBuffer = await r.arrayBuffer();

    // watermark: show password and time (soft watermark overlay)
    const ts = new Date().toLocaleString();
    const watermarkText = `Access: ${pass} • ${ts}`;
    await renderPdfFromArrayBuffer(arrayBuffer, watermarkText);
    showStatus("Opened — reader active", true);

  }catch(e){
    console.error(e);
    showStatus("Unexpected error: " + (e.message||e), false);
  }
});

/* close reader */
closeReader.addEventListener("click", ()=>{
  reader.style.display = "none";
  canvasWrap.innerHTML = "";
  watermark.innerText = "";
  showStatus("Reader closed", true);
});
</script>
</body>
</html>
