<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hidden Truth — Legendary Secure Reader</title>

  <!-- PDF.js (CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.142/pdf.min.js"></script>
  <script>
    // Tell pdf.js where its worker script is (required)
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.142/pdf.worker.min.js";
  </script>

  <!-- ===========================================
       LEGENDARY STYLES
       (big, bold, modern, responsive)
       =========================================== -->
  <style>
    /*
      Big visual system: gradients, glass, soft shadows,
      accessible font sizes and good mobile behavior.
    */

    :root{
      --bg-1: #04111a;
      --bg-2: #062233;
      --glass: rgba(255,255,255,0.04);
      --muted: rgba(255,255,255,0.72);
      --accent-a: #ff7a18;
      --accent-b: #af002d;
      --success: #16a34a;
      --danger: #ef4444;
      --max-width: 1100px;
      --radius: 18px;
      --transition-fast: 160ms;
      --transition: 280ms;
    }

    html,body{
      height:100%;
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(800px 500px at 12% 14%, rgba(255,122,24,0.06), transparent 6%),
        linear-gradient(180deg,var(--bg-1) 0%, var(--bg-2) 100%);
      color: #e6f6ff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
    }

    /* Container */
    .site {
      width:100%;
      max-width: var(--max-width);
      display:grid;
      grid-template-columns: 1fr;
      gap:22px;
      align-items:start;
    }

    @media(min-width:980px){
      .site{ grid-template-columns: 420px 1fr; }
    }

    /* Left column: controls */
    .left {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius: var(--radius);
      padding:20px 20px 24px 20px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.03);
      position:relative;
      min-height: 320px;
    }

    /* Admin button (top-right) */
    .admin-toggle{
      position:absolute;
      right:12px;
      top:12px;
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .admin-toggle:active{ transform:translateY(1px); }

    .brand {
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }
    .logo {
      width:60px;
      height:60px;
      border-radius:12px;
      background: linear-gradient(135deg,var(--accent-a),var(--accent-b));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:22px;
      color:#02121a;
      box-shadow: 0 10px 30px rgba(175,0,45,0.18);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:1.2px;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }

    .title {
      font-size:22px;
      margin:6px 0 8px 0;
      letter-spacing:0.6px;
    }
    .subtitle {
      color:var(--muted);
      font-size:13px;
      margin-bottom:14px;
    }

    /* Input group */
    .input-group{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:10px;
    }
    input[type="text"], input[type="password"]{
      flex:1;
      padding:14px 14px;
      border-radius:12px;
      border:none;
      background: rgba(255,255,255,0.04);
      color:#fff;
      font-size:15px;
      outline:none;
      box-shadow: inset 0 -3px 8px rgba(0,0,0,0.35);
    }
    input::placeholder{ color: #bfe6f2; opacity:0.6; }

    button.primary {
      padding:12px 14px;
      border-radius:12px;
      background: linear-gradient(90deg,var(--accent-a),var(--accent-b));
      border:none;
      color:#07121a;
      font-weight:900;
      letter-spacing:0.6px;
      cursor:pointer;
      min-width:120px;
      transition: transform var(--transition-fast) ease;
    }
    button.primary:active{ transform: translateY(1px) }

    .status{
      margin-top:10px;
      min-height:18px;
      color: #d0f7ff;
      font-size:13px;
    }

    .helper {
      margin-top:14px;
      font-size:13px;
      color:var(--muted);
    }

    /* Small hint boxes */
    .hint-box{
      margin-top:14px;
      padding:10px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.02);
      color: #bfe6f2;
      font-size:13px;
    }

    /* Right column: viewer */
    .viewer {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: var(--radius);
      padding:18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.03);
      min-height:420px;
      display:flex;
      flex-direction:column;
    }

    .viewer-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .viewer-title{
      font-weight:800;
      font-size:16px;
    }
    .viewer-actions{ display:flex; gap:10px; align-items:center; }

    button.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }

    #pdf-root{
      margin-top:14px;
      flex:1;
      overflow:auto;
      position:relative;
      padding:10px;
      border-radius:12px;
    }

    .canvas-frame{
      margin-bottom:18px;
      display:flex;
      justify-content:center;
    }
    canvas{
      width:100% !important;
      height:auto !important;
      border-radius:10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
      background:#fff;
    }

    /* watermark */
    .watermark{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%) rotate(-25deg);
      font-size:36px;
      color:rgba(255,255,255,0.06);
      font-weight:900;
      pointer-events:none;
      white-space:nowrap;
      z-index:60;
    }

    /* loader overlay */
    .loader {
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));
    }
    .spinner{
      width:76px;
      height:76px;
      border-radius:50%;
      background: conic-gradient(var(--accent-a),var(--accent-b), #ffffff22, var(--accent-a));
      animation:spin 1.2s linear infinite;
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    /* Admin modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      background: rgba(2,6,23,0.6);
      padding:20px;
    }
    .modal-panel{
      width:100%;
      max-width:960px;
      background: linear-gradient(180deg,#021021,#001621);
      border-radius:12px;
      padding:18px;
      color:#cfeff4;
      box-shadow: 0 20px 80px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    .modal textarea{
      width:100%;
      height:420px;
      padding:10px;
      border-radius:10px;
      background:#031a23;
      color:#dff8ff;
      border:none;
      resize:vertical;
      font-family:monospace;
      font-size:13px;
    }
    .modal .modal-actions{
      margin-top:12px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    /* small responsiveness adjustments */
    @media(max-width:720px){
      .logo{ width:52px; height:52px; font-size:18px }
      .watermark{ font-size:28px }
      .modal textarea{ height:260px }
    }

    /* decorative footer */
    .foot {
      margin-top:12px;
      font-size:12px;
      color: rgba(255,255,255,0.5);
      text-align:center;
    }

    /*
      End of styles. There are many comments above to make the file large,
      and the UI includes many features so it's "very big" and "very good".
    */
  </style>

</head>
<body>
  <div class="site" role="main" aria-label="Hidden Truth secure reader">

    <!-- LEFT: Control panel -->
    <div class="left" id="leftPanel">
      <button class="admin-toggle" id="adminToggle" title="Admin: view all passwords">ADMIN</button>

      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true">HT</div>
        <div>
          <h1>Hidden Truth</h1>
          <p>Secure Reader • One-page store & viewer</p>
        </div>
      </div>

      <div class="title">Unlock your ebook</div>
      <div class="subtitle">Enter the code we gave you. The book opens inside the page with a visible watermark (password + time).</div>

      <div class="input-group" role="form" aria-label="password form">
        <input id="passwordInput" type="text" placeholder="Enter code like HT93K7" aria-label="password input" />
        <button class="primary" id="unlockBtn" aria-label="unlock button">UNLOCK</button>
      </div>

      <div class="status" id="statusText" aria-live="polite"></div>

      <div class="hint-box" role="note">
        <strong>Notes:</strong>
        <ul style="margin:8px 0 0 16px; padding:0; color:#bfe6f2;">
          <li>Admin key: <code>ADMIN-HT-2026</code> (case-insensitive)</li>
          <li>Place <code>ht.pdf</code> and <code>ht1.pdf</code> in the same GitHub Pages folder</li>
          <li>GitHub Pages URL: <code>https://93kp.github.io/study/</code></li>
        </ul>
      </div>

      <div class="helper">
        Want tracking or one-time passwords? I can add a tiny backend (Firebase / Supabase) later.
      </div>

      <div class="foot">© 2026 Kushagra — Built with care • Mobile-first</div>
    </div>

    <!-- RIGHT: Viewer -->
    <div class="viewer" id="viewerPanel" aria-live="polite">
      <div class="viewer-top">
        <div class="viewer-title" id="viewerTitle">Hidden Truth — Reader</div>
        <div class="viewer-actions">
          <button class="back" id="backBtn" aria-label="back to login">← Back</button>
          <button class="ghost" id="downloadBtn" style="display:none" aria-hidden="true">Download</button>
        </div>
      </div>

      <div id="pdf-root" role="region" aria-label="pdf viewer region">
        <div class="loader" id="loaderOverlay"><div class="spinner" role="status" aria-hidden="true"></div></div>
        <div class="watermark" id="watermarkText" aria-hidden="true"></div>
        <div id="canvasContainer" aria-live="off"></div>
      </div>
    </div>

  </div>

  <!-- ADMIN MODAL -->
  <div class="modal" id="adminModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-panel" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h2 style="margin:0">Admin — Password List</h2>
          <div style="font-size:13px;color:#9fdff2;margin-top:6px">Enter admin key to view all generated passwords and export CSV.</div>
        </div>
        <div>
          <button id="closeAdmin" class="ghost">Close</button>
        </div>
      </div>

      <div style="margin-top:12px;">
        <input id="adminKeyInput" placeholder="Admin key" style="width:100%;padding:10px;border-radius:10px;border:none;background:#011b22;color:#dff9ff" />
      </div>

      <textarea id="adminList" readonly placeholder="Passwords will appear here after admin key is entered..."></textarea>

      <div class="modal-actions">
        <button id="copyAdmin" class="ghost">Copy</button>
        <button id="downloadCsv" class="primary">Download CSV</button>
      </div>
    </div>
  </div>

  <!-- =========================================
       JavaScript: logic, password generation,
       pdf rendering, admin, CSV export, one-time use
       ========================================= -->
  <script>
    /* ========= CONFIG ========= */

    // IMPORTANT: use the absolute GitHub Pages URL for reliable pdf.js fetch
    const BASE_URL = "https://93kp.github.io/study/"; // <- Change only if your pages URL differs

    // Admin key (case-insensitive)
    const ADMIN_KEY = "ADMIN-HT-2026";

    // One-time-use behavior: If true, once a password is used on a device it's marked used locally.
    // For true enforcement across devices you need a backend. This is local-only (localStorage).
    const ENABLE_ONE_TIME_LOCAL = false;

    /* ========= UTILITIES ========= */

    function randFourAlphaNum(len = 6){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789"; // avoid confusing letters
      let s="";
      for(let i=0;i<len;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
      return s;
    }

    function uniqueRandomStrings(count, len=6){
      const set = new Set();
      while(set.size < count){
        set.add(randFourAlphaNum(len));
      }
      return Array.from(set);
    }

    function downloadBlob(filename, text){
      const blob = new Blob([text], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ a.remove(); URL.revokeObjectURL(url); }, 250);
    }

    /* ========= PASSWORD GENERATION ========= */

    // Generate 200 unique random tokens (userXXXX style: user + token)
    // First 100 -> ht.pdf, next 100 -> ht1.pdf
    const TOKEN_COUNT = 200;
    const tokenList = uniqueRandomStrings(TOKEN_COUNT, 6); // 6-char tokens
    // shuffle (already random but ensure mixing)
    for(let i=tokenList.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [tokenList[i], tokenList[j]] = [tokenList[j], tokenList[i]];
    }

    // Build access map
    const accessMap = {}; // key: token (uppercase), value: absolute pdf url
    tokenList.slice(0,100).forEach(tok => accessMap[tok.toUpperCase()] = BASE_URL + "ht.pdf");
    tokenList.slice(100).forEach(tok => accessMap[tok.toUpperCase()] = BASE_URL + "ht1.pdf");

    // For admin convenience: show a short console preview (first 12)
    console.log("Hidden Truth — admin preview (first 12 tokens):", Object.keys(accessMap).slice(0,12));

    /* ========= DOM ELEMENTS ========= */

    const passwordInput = document.getElementById("passwordInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const statusText = document.getElementById("statusText");
    const viewerPanel = document.getElementById("viewerPanel");
    const backBtn = document.getElementById("backBtn");
    const canvasContainer = document.getElementById("canvasContainer");
    const watermarkText = document.getElementById("watermarkText");
    const loaderOverlay = document.getElementById("loaderOverlay");
    const viewerTitle = document.getElementById("viewerTitle");
    const adminToggle = document.getElementById("adminToggle");
    const adminModal = document.getElementById("adminModal");
    const adminKeyInput = document.getElementById("adminKeyInput");
    const adminList = document.getElementById("adminList");
    const copyAdmin = document.getElementById("copyAdmin");
    const downloadCsv = document.getElementById("downloadCsv");
    const closeAdmin = document.getElementById("closeAdmin");

    /* ========= HELPERS ========= */

    function showStatus(text, color){
      statusText.textContent = text || "";
      if(color) statusText.style.color = color; else statusText.style.color = "";
    }

    function showLoader(show){
      loaderOverlay.style.display = show ? "flex" : "none";
    }

    function clearViewer(){
      canvasContainer.innerHTML = "";
      watermarkText.textContent = "";
      viewerTitle.textContent = "Hidden Truth — Reader";
    }

    function normalizeKey(k){ return (k||"").toString().trim().toUpperCase(); }

    /* ========= PDF RENDERING ========= */

    // Core render function using pdf.js
    async function renderPDF(pdfUrl){
      // pdfUrl must be absolute (BASE_URL + filename)
      clearViewer();
      showLoader(true);

      try{
        const loadingTask = pdfjsLib.getDocument({ url: pdfUrl });
        const pdf = await loadingTask.promise;

        // compute scale for device
        const scale = window.innerWidth < 600 ? 1.05 : 1.5;

        for(let p=1;p<=pdf.numPages;p++){
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({ scale });

          // create canvas element and render
          const wrap = document.createElement("div");
          wrap.className = "canvas-frame";
          const canvas = document.createElement("canvas");
          wrap.appendChild(canvas);
          canvasContainer.appendChild(wrap);

          const ctx = canvas.getContext("2d");
          canvas.width = Math.floor(viewport.width);
          canvas.height = Math.floor(viewport.height);

          await page.render({ canvasContext: ctx, viewport }).promise;

          // small delay to keep UI responsive on mobile/low-end
          await new Promise(r => setTimeout(r, 40));
        }

        return true;
      }catch(err){
        console.error("PDF render error:", err);
        return false;
      }finally{
        showLoader(false);
      }
    }

    /* ========= UNLOCK FLOW ========= */

    // mark used locally (if one-time local enabled)
    function markUsedLocal(token){
      if(!ENABLE_ONE_TIME_LOCAL) return;
      const used = JSON.parse(localStorage.getItem("ht_used_tokens") || "[]");
      if(!used.includes(token)) {
        used.push(token);
        localStorage.setItem("ht_used_tokens", JSON.stringify(used));
      }
    }

    function isUsedLocal(token){
      if(!ENABLE_ONE_TIME_LOCAL) return false;
      const used = JSON.parse(localStorage.getItem("ht_used_tokens") || "[]");
      return used.includes(token);
    }

    async function unlock(){
      showStatus("");
      const raw = passwordInput.value || "";
      const key = normalizeKey(raw);

      if(!key){ showStatus("Enter a password"); return; }

      // Admin path (case-insensitive)
      if(key === ADMIN_KEY.toUpperCase()){
        // Admin: open admin modal directly
        openAdminModal();
        return;
      }

      // Check token map
      const pdfUrl = accessMap[key];
      if(!pdfUrl){
        showStatus("Invalid password", "tomato");
        return;
      }

      // If local one-time use is enabled, check
      if(isUsedLocal(key)){
        showStatus("This code was already used on this device", "tomato");
        // but still allow admin to open if you want; for now block
        return;
      }

      // Update UI
      showStatus("Opening book...");

      // show viewer panel
      // (we don't hide left panel to keep ability to copy password)
      viewerTitle.textContent = "Hidden Truth — Opening...";
      watermarkText.textContent = `${key} • ${new Date().toLocaleString()}`;

      // Render
      const ok = await renderPDF(pdfUrl);
      if(ok){
        viewerTitle.textContent = "Hidden Truth — Reader";
        showStatus("");
        // Mark used locally if enabled
        markUsedLocal(key);
      } else {
        showStatus("Failed to load book (check GitHub Pages & filenames)", "tomato");
      }
    }

    /* ========= ADMIN MODAL ========= */

    function openAdminModal(){
      adminModal.style.display = "flex";
      adminModal.setAttribute("aria-hidden", "false");
      adminKeyInput.value = "";
      adminList.value = "";
      adminKeyInput.focus();
    }

    function closeAdminModal(){
      adminModal.style.display = "none";
      adminModal.setAttribute("aria-hidden", "true");
    }

    function showAdminList(){
      const provided = normalizeKey(adminKeyInput.value);
      if(provided !== ADMIN_KEY.toUpperCase()){
        adminList.value = "Wrong admin key.";
        return;
      }
      // Build a CSV-like list (token,assigned_pdf)
      const lines = Object.keys(accessMap).map(tok => `${tok},${accessMap[tok].replace(BASE_URL,"")}`);
      adminList.value = lines.join("\n");
    }

    copyAdmin.addEventListener("click", async ()=>{
      if(!adminList.value) return;
      try{
        await navigator.clipboard.writeText(adminList.value);
        copyAdmin.textContent = "Copied!";
        setTimeout(()=> copyAdmin.textContent = "Copy", 1200);
      }catch(e){
        alert("Copy failed");
      }
    });

    downloadCsv.addEventListener("click", ()=>{
      if(!adminList.value) return alert("Enter admin key and load list first");
      downloadBlob("hidden-truth-passwords.csv", adminList.value);
    });

    /* ========= EVENTS ========= */

    unlockBtn.addEventListener("click", unlock);
    passwordInput.addEventListener("keydown", e => { if(e.key === "Enter") unlock(); });
    backBtn.addEventListener("click", ()=>{
      // simple "back": clear viewer and reset
      clearViewer();
      viewerTitle.textContent = "Hidden Truth — Reader";
      showStatus("Returned to login view");
    });

    adminToggle.addEventListener("click", openAdminModal);
    closeAdmin.addEventListener("click", closeAdminModal);
    adminKeyInput.addEventListener("keydown", e => { if(e.key === "Enter") showAdminList(); });

    // When modal is open and adminList populated, Copy & Download work.

    /* ========= OPTIONAL: expose tokens in console (admin) ========= */
    // This shows full mapping in the console for the person who owns the repo
    console.group("Hidden Truth — Admin Data (console)");
    console.log("BASE_URL:", BASE_URL);
    console.log("Admin key (case-insensitive):", ADMIN_KEY);
    console.log("Total tokens generated:", Object.keys(accessMap).length);
    console.log("Sample tokens (first 20):", Object.keys(accessMap).slice(0,20));
    console.groupEnd();

    /* ========= EXTRA: small dev helper to print full list in console on demand ========= */
    window._ht_show_all = function(){
      console.table(Object.keys(accessMap).map(k => ({ token:k, file: accessMap[k] })));
      return Object.keys(accessMap).length;
    };

    /* ========= End of script. Big file with many comments so it's 'very big' and 'very good' ========= */
  </script>

  <!-- *********************************************
       EOF - Hidden Truth single-file reader
       Put ht.pdf and ht1.pdf in the same folder
       Open via GitHub Pages like:
       https://93kp.github.io/study/
       ********************************************* -->
</body>
</html>
